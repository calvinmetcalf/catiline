/*! communist 1.7.2 2013-07-16*/
/*!(c)2013 Calvin Metcalf @license MIT https://github.com/calvinmetcalf/communist */
/*!Includes Promiscuous (c)2013 Ruben Verborgh @license MIT https://github.com/RubenVerborgh/promiscuous*/
/*!Includes Material from setImmediate Copyright (c) 2012 Barnesandnoble.com, llc, Donavon West, and Domenic Denicola @license MIT https://github.com/NobleJS/setImmediate */
"undefined"==typeof document?(self._noTransferable=!0,self.onmessage=function(e){eval(e.data)}):function(global){"use strict";function regexImports(a){for(var b=a,d=!0,e={},f=function(a,b){b&&"importScripts("+b.split(",").forEach(function(a){e[c.makeUrl(a.slice(1,-1))]=!0})+");\n"};d;)d=b.match(/(importScripts\(.*?\);)/),b=b.replace(/(importScripts\((?:.*?\.js[\'\"])?\);?)/,"\n"),d&&d[0].replace(/importScripts\((.*?\.js[\'\"])\);?/g,f);return e=Object.keys(e),[e,b]}function moveImports(a){var b=regexImports(a),c=b[0],d=b[1];return c.length>0?'importScripts("'+c.join('","')+'");\n'+d:d}function getPath(){if("undefined"!=typeof SHIM_WORKER_PATH)return SHIM_WORKER_PATH;for(var a=document.getElementsByTagName("script"),b=a.length,c=0;b>c;){if(/communist(\.min)?\.js/.test(a[c].src))return a[c].src;c++}}function makeWorker(a){var b,d=moveImports(a.join(""));c.URL=c.URL||window.URL||window.webkitURL;try{b=new Worker(c.URL.createObjectURL(new Blob([d],{type:"text/javascript"})))}catch(e){c._noTransferable=!0,b=new Worker(getPath()),b.postMessage(d)}finally{return b}}function single(a,b){if("undefined"==typeof Worker||"undefined"!=typeof fakeLegacy)return multiUse(a).data(b);var d=c.deferred(),e={fun:a,data:JSON.stringify(b),init:function(){var a=this,b=JSON.parse(this.data),c=function(b,c){a.fire("done",b,c)},d=a.fun(b,c);"undefined"!=typeof d&&c(d)}},f=object(e);return f.on("done",function(a){d.resolve(a),f.close()}),f.on("error",function(a){a.preventDefault(),d.reject(a.message),f.close()}),d.promise}function mapWorker(a,b,c){c=c||function(){b()};var d=new Communist,e={__func__:a};e.data=function(a){var b=this,c=function(a,c){b.fire("data",a,c)},d=b.__func__(a,c);"undefined"!=typeof d&&c(d)},e.init=function(){this.on("data",function(a){this.data(a)})};var f=object(e);return d.data=function(a,b){return f.fire("data",a,b),d},f.on("data",b),f.on("error",c),d.close=function(){return f.close()},d}function multiUse(a){return object({data:a})}function fakeObject(inObj){function ajax(a){var b=c.deferred(),d=new XMLHttpRequest;return d.open("GET",a),d.onload=function(){b.resolve(d.responseText)},d.onerror=function(){b.reject("failed to download")},d.send(),b.promise}function addEvents(a,b){a.on=function(b,c,d){return d=d||a,b.indexOf(" ")>0?(b.split(" ").map(function(b){return a.on(b,c,d)},this),a):(b in wlisteners||(wlisteners[b]=[]),wlisteners[b].push(function(a){c.call(d,a)}),void 0)},a.fire=function(b,d){return c.setImmediate(function(){b in olisteners&&Array.isArray(olisteners[b])&&olisteners[b].forEach(function(a){a(d)})}),a},a.off=function(b,c){return b.indexOf(" ")>0?(b.split(" ").map(function(b){return a.off(b,c)}),a):b in wlisteners?(c?wlisteners[b].indexOf(c)>-1&&(wlisteners[b].length>1?delete wlisteners[b]:wlisteners[b].splice(wlisteners[b].indexOf(c),1)):delete wlisteners[b],a):a},b.on=function(a,c,d){return d=d||b,a.indexOf(" ")>0?(a.split(" ").map(function(a){return b.on(a,c,d)},this),b):(a in olisteners||(olisteners[a]=[]),olisteners[a].push(function(a){try{c.call(d,a)}catch(e){b.fire("error",{preventDefault:function(){},messege:e})}}),b)},b.fire=function(a,c){return a in wlisteners?(wlisteners[a].forEach(function(a){a(c)}),b):b},b.off=function(a,c){return a.indexOf(" ")>0?(a.split(" ").map(function(a){return b.off(a,c)}),b):a in olisteners?(c?olisteners[a].indexOf(c)>-1&&(olisteners[a].length>1?delete olisteners[a]:olisteners[a].splice(olisteners[a].indexOf(c),1)):delete olisteners[a],b):b}}var w=new Communist,promises=[],loaded=!1,wlisteners={},olisteners={},loading,called=!1,rejectPromises=function(a){"string"!=typeof a&&a.preventDefault&&(a.preventDefault(),a=a.message),promises.forEach(function(b){b&&b.reject(a)})},obj;"initialize"in inObj||(inObj.initialize="init"in inObj?inObj.init:function(){});var keyFunc=function(a){var b=function(b){var d,e,f;e=promises.length,called||(called=!0),promises[e]=c.deferred(),f=function(a){promises[e].resolve(a)};try{d=obj[a].call(obj,b,f),"undefined"!=typeof d&&f(d)}catch(g){obj.fire("error",{preventDefault:function(){},messege:g}),promises[e].reject({preventDefault:function(){},messege:g})}return promises[e].promise};return function(a){return loaded?b(a):loading.then(function(){return b(a)})}},i=0,fObj="{";for(var key in inObj)0!==i?fObj+=",":i++,fObj=fObj+key+":"+inObj[key].toString(),w[key]=keyFunc(key);fObj+="}";var re=/(\S+?:function\s*?)(\S+?)(\s*?\()/g,regexed=regexImports(fObj),forImport=regexed[0];return 0===forImport.length?(loaded=!0,function(){eval("obj = "+regexed[1].replace(re,"$1$3"))}(),addEvents(w,obj)):loading=c.all(forImport.map(function(a){return ajax(a)})).then(function(array){return eval(array.join("\n")+";\nobj = "+regexed[1].replace(re,"$1$3")),addEvents(w,obj),!0}),w._close=function(){return olisteners={},wlisteners={},promises.forEach(function(a){a.reject("closed")}),c.resolve()},"close"in w||(w.close=w._close),called||w.initialize("init"),w}function fakeReducer(a,b){var c,d=new Communist;return d.data=function(b){return c=c?a(c,b):b,d},d.fetch=function(){return b(c),d},d.close=function(a){a||b(c)},d}function object(a){if("undefined"==typeof Worker||"undefined"!=typeof fakeLegacy)return fakeObject(a);var b={},d=new Communist;d.on=function(a,c,e){return e=e||d,a.indexOf(" ")>0?(a.split(" ").map(function(a){return d.on(a,c,e)},this),d):(a in b||(b[a]=[]),b[a].push(function(a){c.call(e,a)}),d)};var e=function(a,c){return a in b?(b[a].forEach(function(a){a(c)}),d):d};d.fire=function(a,b,e){return c._noTransferable?l.postMessage([[a],b]):l.postMessage([[a],b],e),d},d.off=function(a,c){return a.indexOf(" ")>0?(a.split(" ").map(function(a){return d.off(a,c)}),d):a in b?(c?b[a].indexOf(c)>-1&&(b[a].length>1?delete b[a]:b[a].splice(b[a].indexOf(c),1)):delete b[a],d):d};var f=0,g=[],h=function(a){"string"!=typeof a&&"preventDefault"in a&&(a.preventDefault(),a=a.message),g.forEach(function(b){b&&b.reject(a)})};"initialize"in a||(a.initialize="init"in a?a.init:function(){});var i="{",j=function(a){var b=function(b,d){var e=g.length;return g[e]=c.deferred(),c._noTransferable?l.postMessage([["com.communistjs",e],a,b]):l.postMessage([["com.communistjs",e],a,b],d),g[e].promise};return b};for(var k in a)0!==f?i+=",":f++,i=i+k+":"+a[k].toString(),d[k]=j(k);i+="}";var l=makeWorker(["var _db = ",i,';var listeners = {};_db.on = function (eventName, func, scope) {	if(eventName.indexOf(" ")>0){		return eventName.split(" ").map(function(v){			return _db.on(v,func,scope);		},_db);	}	scope = scope || _db;	if (!(eventName in listeners)) {		listeners[eventName] = [];	}	listeners[eventName].push(function (a) {		func.call(scope, a);	});};var _fire = function (eventName, data) {	if (!(eventName in listeners)) {		return;	}	listeners[eventName].forEach(function (v) {		v(data);	});};_db.fire = function (eventName, data, transfer) {	!self._noTransferable ? self.postMessage([		[eventName], data], transfer) : self.postMessage([		[eventName], data]);};_db.off=function(eventName,func){	if(eventName.indexOf(" ")>0){		return eventName.split(" ").map(function(v){			return _db.off(v,func);		});	}	if(!(eventName in listeners)){		return;	}else if(!func){		delete listeners[eventName];	}else{		if(listeners[eventName].indexOf(func)>-1){			if(listeners[eventName].length>1){				delete listeners[eventName];			}else{				listeners[eventName].splice(listeners[eventName].indexOf(func),1);			}		}	}};var console={};function makeConsole(method){	return function(){		var len = arguments.length;		var out =[];		var i = 0;		while (i<len){			out.push(arguments[i]);			i++;		}		_db.fire("console",[method,out]);	};}["log", "debug", "error", "info", "warn", "time", "timeEnd"].forEach(function(v){	console[v]=makeConsole(v);});self.onmessage=function(e){	_fire("messege",e.data[1]);	if(e.data[0][0]==="com.communistjs"){		return regMsg(e);	}else{		_fire(e.data[0][0],e.data[1]);	}};var regMsg = function(e){	var cb=function(data,transfer){		!self._noTransferable?self.postMessage([e.data[0],data],transfer):self.postMessage([e.data[0],data]);	};	var result = _db[e.data[1]](e.data[2],cb);	if(typeof result !== "undefined"){		cb(result);	}};_db.initialize();']);return l.onmessage=function(a){e("message",a.data[1]),"com.communistjs"===a.data[0][0]?(g[a.data[0][1]].resolve(a.data[1]),g[a.data[0][1]]=0):e(a.data[0][0],a.data[1])},l.onerror=function(a){h(a),e("error",a)},d.on("console",function(a){console[a[0]].apply(console,a[1])}),d._close=function(){return l.terminate(),h("closed"),c.resolve()},"close"in d||(d.close=d._close),d}function queue(a,b,d){function e(a){a=a||"canceled",r=0;var b=q;return q=[],b.forEach(function(b){b[3].reject(a)}),m}function f(a){return function(b,c){return l(a,b,c)}}function g(a){return function(b){return c.all(b.map(function(b){return l(a,b)}))}}function h(a){return function(b){var d=this;return c.all(b.map(function(b){return l(a,b).then(d.__cb__)}))}}function i(a){return function(b){return c.all(b.map(function(b){return l(a,b[0],b[1])}))}}function j(a){return function(b){var d=this;return c.all(b.map(function(b){return l(a,b[0],b[1]).then(d.__cb__)}))}}function k(a){var b;r?(b=q.shift(),r--,n[a][b[0]](b[1],b[2]).then(function(c){k(a),b[3].resolve(c)},function(c){k(a),b[3].reject(c)})):(o++,p.push(a))}function l(a,e,f){if(d)return n[~~(Math.random()*b)][a](e,f);var g,h=c.deferred();return!r&&o?(g=p.pop(),o--,n[g][a](e,f).then(function(a){k(g),h.resolve(a)},function(a){k(g),h.reject(a)})):(r||!o)&&(r=q.push([a,e,f,h])),h.promise}var m=new Communist;m.__batchcb__=new Communist,m.__batchtcb__=new Communist,m.batch=function(a){return"function"==typeof a?(m.__batchcb__.__cb__=a,m.__batchcb__):e(a)},m.batchTransfer=function(a){return"function"==typeof a?(m.__batchtcb__.__cb__=a,m.__batchtcb__):e(a)};for(var n=new Array(b),o=0,p=[],q=[],r=0;b>o;)n[o]=object(a),p.push(o),o++;m.on=function(a,b,c){return n.forEach(function(d){d.on(a,b,c)}),m},m.off=function(a,b,c){return n.forEach(function(d){d.off(a,b,c)}),m};var s=function(a,b){return n.forEach(function(c){c.fire(a,b)}),m};m.fire=function(a,c){return n[~~(Math.random()*b)].fire(a,c),m},m.batch.fire=s,m.batchTransfer.fire=s;for(var t in a)m[t]=f(t),m.batch[t]=g(t),m.__batchcb__[t]=h(t),m.batchTransfer[t]=i(t),m.__batchtcb__[t]=j(t);return m._close=function(){return c.all(n.map(function(a){return a._close()}))},"close"in m||(m.close=m._close),m}function rWorker(a,b){if("undefined"==typeof Worker||"undefined"!=typeof fakeLegacy)return fakeReducer(a,b);new Communist;var c={fun:a,data:function(a){this._r=this._r?this.fun(this._r,a):a},fetch:function(){return this._r},close:function(a,b){a||b(this._r),self.terminate}},d=object(c);return d.on("message",b),d}function incrementalMapReduce(a){function b(){for(var a=0,b=i.length;b>a&&h>0&&k>0;)h--,i[a].data(j.pop()),a++,k--;return g}function d(){f.close(),i.forEach(function(a){a.close()})}var e,f,g=new Communist,h=0,i=[],j=[],k=a,l=!1,m=!1,n={map:!1,reduce:!1,data:!1},o=function(){return n.map&&n.reduce&&n.data?b():g};return g.map=function(b,c){function e(){function e(b){void 0!==typeof b&&f.data(b),h>0?(h--,g=j.pop(),c?p.data(g,[g]):p.data(g)):(k++,k===a&&(n.data=!1,m?d():l&&(l=!1,f.fetch())))}var g,o=multiUse(b),p={data:function(a){o.data(a).then(e)},close:function(){o.close()}};i.push(p)}if(n.map)return g;for(var p=0;a>p;)e(),p++;return n.map=!0,o()},g.reduce=function(a){return n.reduce?g:(f=rWorker(a,function(a){e&&(e.resolve(a),e=!1)}),n.reduce=!0,o())},g.data=function(a){return m?void 0:(h+=a.length,j=j.concat(a),n.data=!0,o())},g.fetch=function(b){return e||(e=c.deferred()),a>k&&!b?l=!0:f.fetch(),e.promise},g.close=function(){return e||(e=c.deferred()),a>k?m=!0:d(),e.promise},g}function nonIncrementalMapReduce(a){function b(){return e.data&&e.map&&e.reduce?d.close():c}var c=new Communist,d=incrementalMapReduce(a),e={data:!1,map:!1,reduce:!1};return c.map=function(a,c){return e.map=!0,d.map(a,c),b()},c.reduce=function(a){return e.reduce=!0,d.reduce(a),b()},c.data=function(a){return e.data=!0,d.data(a),b()},c}function c(a,b,d){return"number"!=typeof a&&"function"==typeof b?c.mapper(a,b,d):"object"!=typeof a||Array.isArray(a)?"number"!=typeof a?b?c.singleUse(a,b):c.communist(a):"number"==typeof a?c.mapReduce(a,b):void 0:"number"==typeof b?c.queue(a,b,d):c.communist(a)}function initBrowser(a){var b=global.cw;a.noConflict=function(c){global.cw=b,c&&(global[c]=a)},global.communist=a,global.cw=a}!function(attachTo,global){function isStringAndStartsWith(a,b){return"string"==typeof a&&a.substring(0,b.length)===b}function onGlobalMessage(a){if(a.source===global&&isStringAndStartsWith(a.data,MESSAGE_PREFIX)){var b=a.data.substring(MESSAGE_PREFIX.length);tasks.runIfPresent(b)}}var tasks=function(){function Task(a,b){this.handler=a,this.args=b}Task.prototype.run=function(){if("function"==typeof this.handler)this.handler.apply(void 0,this.args);else{var scriptSource=""+this.handler;eval(scriptSource)}};var nextHandle=1,tasksByHandle={},currentlyRunningATask=!1;return{addFromSetImmediateArguments:function(a){var b=a[0],c=Array.prototype.slice.call(a,1),d=new Task(b,c),e=nextHandle++;return tasksByHandle[e]=d,e},runIfPresent:function(a){if(currentlyRunningATask)global.setTimeout(function(){tasks.runIfPresent(a)},0);else{var b=tasksByHandle[a];if(b){currentlyRunningATask=!0;try{b.run()}finally{delete tasksByHandle[a],currentlyRunningATask=!1}}}},remove:function(a){delete tasksByHandle[a]}}}(),MESSAGE_PREFIX="com.communistjs.setImmediate"+Math.random();global.addEventListener?global.addEventListener("message",onGlobalMessage,!1):global.attachEvent("onmessage",onGlobalMessage),attachTo.setImmediate=function(){var a=tasks.addFromSetImmediateArguments(arguments);return global.postMessage(MESSAGE_PREFIX+a,"*"),a}}(c,global),function(a){function b(){var a=function(g,h,i){var j;if(g!==a)return j=b(),a.c.push({d:j,resolve:g,reject:h}),j.promise;for(var k,l,m,n=h?"resolve":"reject",o=0,p=a.c.length;p>o;o++)k=a.c[o],l=k.d,m=k[n],typeof m!==e?l[n](i):d(m,i,l);a=c(f,i,h)},f={then:function(b,c){return a(b,c)}};return a.c=[],{promise:f,resolve:function(b){a.c&&a(a,!0,b)},reject:function(b){a.c&&a(a,!1,b)}}}function c(a,c,f){return function(g,h){var i,j=f?g:h;return typeof j!==e?a:(d(j,c,i=b()),i.promise)}}function d(b,c,d){a.setImmediate(function(){var a;try{a=b(c),a&&typeof a.then===e?a.then(d.resolve,d.reject):d.resolve(a)}catch(f){d.reject(f)}})}var e="function";a.resolve=function(a){var b={};return b.then=c(b,a,!0),b},a.reject=function(a){var b={};return b.then=c(b,a,!1),b},a.deferred=b}(c),c.all=function(a){var b=c.deferred(),d=a.length,e=0,f=new Array(d),g=function(a){return function(c){f[a]=c,e++,e===d&&b.resolve(f)}};return a.forEach(function(a,c){a.then(g(c),function(a){b.reject(a)})}),b.promise};var Communist=function(){};c.reducer=rWorker,c.mapper=mapWorker,c.worker=makeWorker,c.makeWorker=makeWorker,c.makeUrl=function(a){var b=document.createElement("link");return b.href=a,b.href},c.singleUse=single,c.communist=function(a){return"function"==typeof a?object({data:a}):object(a)},c.mapReduce=function(a,b){return b?nonIncrementalMapReduce(a):incrementalMapReduce(a)},c.queue=queue,c.ajax=function(a,b,d){var e={ajax:function(a,b){var c=this,d=new XMLHttpRequest;d.open("GET",a),d.onreadystatechange=function(){var a;4===d.readyState&&200===d.status&&(a=c.after(c.notjson?d.responseText:JSON.parse(d.responseText)),"undefined"!=typeof a&&b(a))},d.onerror=function(a){throw a},d.send()}};return e.after=b||function(a){return a},e.notjson=d||!1,c(e).ajax(c.makeUrl(a))},"undefined"!=typeof module&&"exports"in module?module.exports=c:initBrowser(c),c.version="1.7.2"}(this);
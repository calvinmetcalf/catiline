/*! communist 2013-05-29*/
/*!(c)2013 Calvin Metcalf @license MIT https://github.com/calvinmetcalf/communist */
/*!Includes Promiscuous (c)2013 Ruben Verborgh @license MIT https://github.com/RubenVerborgh/promiscuous*/
/*!Includes Material from setImmediate Copyright (c) 2012 Barnesandnoble.com, llc, Donavon West, and Domenic Denicola @license MIT https://github.com/NobleJS/setImmediate */
"undefined"==typeof document?(self._noTransferable=!0,self.onmessage=function(e){eval(e.data)}):function(){"use strict";function moveImports(e){var n,t=e.match(/(importScripts\(.*\);)/);return n=t?t[0].replace(/importScripts\((.*\.js\')\);?/,function(e,n){return n?"importScripts("+n.split(",").map(function(e){return"'"+c.makeUrl(e.slice(1,-1))+"'"})+");\n":""})+e.replace(/(importScripts\(.*\.js\'\);?)/,"\n"):e}function getPath(){if("undefined"!=typeof SHIM_WORKER_PATH)return SHIM_WORKER_PATH;for(var e=document.getElementsByTagName("script"),n=e.length,t=0;n>t;){if(/communist(\.min)?\.js/.test(e[t].src))return e[t].src;t++}}function makeWorker(e){var n,t=moveImports(e.join(""));c.URL=c.URL||window.URL||window.webkitURL;try{n=new Worker(c.URL.createObjectURL(new Blob([t],{type:"text/javascript"})))}catch(r){c._noTransferable=!0,n=new Worker(getPath()),n.postMessage(t)}finally{return n}}function single(e,n){var t=c.deferred(),r=makeWorker(["var _self={};\n_self.fun = ",e,";\n	_self.cb=function(data,transfer){\n			!self._noTransferable?self.postMessage(data,transfer):self.postMessage(data);\n			self.close();\n		};\n		_self.result = _self.fun(",JSON.stringify(n),',_self.cb);\n		if(typeof _self.result !== "undefined"){\n			_self.cb(_self.result);\n		}']);return r.onmessage=function(e){t.resolve(e.data)},r.onerror=function(e){e.preventDefault(),t.reject(e.message)},t.promise}function mapWorker(e,n,t){var r=new Communist,a=makeWorker(["\n	var _db={};\n	_db.__close__=function(){\n		self.close();\n	};\n	var _self={};\n	_db.__fun__ = ",e,';\n	_self.cb=function(data,transfer){\n		!self._noTransferable?self.postMessage(data,transfer):self.postMessage(data);\n	};\n	self.onmessage=function(e){\n		_self.result = _db.__fun__(e.data,_self.cb);\n			if(typeof _self.result !== "undefined"){\n				_self.cb(_self.result);\n		}\n	}']);return a.onmessage=function(e){n(e.data)},a.onerror=t?t:function(){n()},r.data=function(e,n){return c._noTransferable?a.postMessage(e):a.postMessage(e,n),r},r.close=function(){return a.terminate()},r}function multiUse(e){return object({data:e})}function object(e){var n=new Communist,t=0,r=[],a=function(e){"string"!=typeof e&&e.preventDefault&&(e.preventDefault(),e=e.message),r.forEach(function(n){n&&n.reject(e)})};"initialize"in e||(e.initialize=function(){});var o="{",u=function(e){var n=function(n,t){var a=r.length;return r[a]=c.deferred(),c._noTransferable?i.postMessage([a,e,n]):i.postMessage([a,e,n],t),r[a].promise};return n};for(var s in e)0!==t?o+=",":t++,o=o+s+":"+(""+e[s]),n[s]=u(s);o+="}";var i=makeWorker(["\n	var _db="+o+';\n	self.onmessage=function(e){\n	var cb=function(data,transfer){\n		!self._noTransferable?self.postMessage([e.data[0],data],transfer):self.postMessage([e.data[0],data]);\n	};\n		var result = _db[e.data[1]](e.data[2],cb);\n			if(typeof result !== "undefined"){\n				cb(result);\n			}\n	}\n	_db.initialize()']);return i.onmessage=function(e){r[e.data[0]].resolve(e.data[1]),r[e.data[0]]=0},i.onerror=a,n._close=function(){return i.terminate(),a("closed"),c.resolve("done")},"close"in n||(n.close=n._close),n}function queue(e,n,t,r){function a(e){return function(n,t){return i(e,n,t)}}function o(e){return t?function(n){n.forEach(function(n){i(e,n).then(t)})}:function(n){return c.all(n.map(function(n){return i(e,n)}))}}function u(e){return t?function(n){n.forEach(function(n){i(e,n[0],n[1]).then(t)})}:function(n){return c.all(n.map(function(n){return i(e,n[0],n[1])}))}}function s(e){var n;v?(n=p.shift(),v--,l[e][n[0]](n[1],n[2]).then(function(t){s(e),n[3].resolve(t)},function(t){s(e),n[3].reject(t)})):(d++,m.push(e))}function i(e,n,t){var r,a=c.deferred();return!v&&d?(r=m.pop(),d--,l[r][e](n,t).then(function(e){s(r),a.resolve(e)},function(e){s(r),a.reject(e)})):(v||!d)&&(v=p.push([e,n,t,a])),a.promise}if("dumb"===t)return dumbQueue(e,n);if("dumb"===r)return dumbQueue(e,n,t);var f=new Communist;f.batch={},f.batchTransfer={};for(var l=Array(n),d=0,m=[],p=[],v=0;n>d;)l[d]=object(e),m.push(d),d++;e._close=function(){};for(var h in e)f[h]=a(h),f.batch[h]=o(h),f.batchTransfer[h]=u(h);return"close"in f||(f.close=f._close),f}function dumbQueue(e,n,t){function r(e){return function(n,t){return u(e,n,t)}}function a(e){return t?function(n){n.forEach(function(n){u(e,n).then(t)})}:function(n){return c.all(n.map(function(n){return u(e,n)}))}}function o(e){return t?function(n){n.forEach(function(n){u(e,n[0],n[1]).then(t)})}:function(n){return c.all(n.map(function(n){return u(e,n[0],n[1])}))}}function u(e,t,r){return i[~~(Math.random()*n)][e](t,r)}var s=new Communist;s.batch={},s.batchTransfer={};for(var i=Array(n),f=0,l=[];n>f;)i[f]=object(e),l.push(f),f++;e._close=function(){};for(var d in e)s[d]=r(d),s.batch[d]=a(d),s.batchTransfer[d]=o(d);return"close"in s||(s.close=s._close),s}function rWorker(e,n){var t=new Communist,r="function(dat,cb){ var fun = "+e+';\n		switch(dat[0]){\n			case "data":\n				if(!this._r){\n					this._r = dat[1];\n				}else{\n					this._r = fun(this._r,dat[1]);\n				}\n				break;\n			case "get":\n				return cb(this._r);\n			case "close":\n				cb(this._r);\n				this.__close__();\n				break;\n		}\n	};',a=function(e){n(e)},o=mapWorker(r,a);return t.data=function(e,n){return c._noTransferable?o.data(["data",e]):o.data(["data",e],n),t},t.fetch=function(){return o.data(["get"]),t},t.close=function(e){e&&(n=function(){}),o.data(["close"])},t}function incrementalMapReduce(e){function n(){for(var e=0,n=s.length;n>e&&u>0&&f>0;)u--,s[e].data(i.pop()),e++,f--;return o}function t(){a.close(),s.forEach(function(e){e.close()})}var r,a,o=new Communist,u=0,s=[],i=[],f=e,l=!1,d=!1,m={map:!1,reduce:!1,data:!1},p=function(){return m.map&&m.reduce&&m.data?n():o};return o.map=function(n,r){if(m.map)return o;for(var c=0;e>c;)(function(){var o,c=mapWorker(n,function(n){void 0!==typeof n&&a.data(n),u>0?(u--,o=i.pop(),r?c.data(o,[o]):c.data(o)):(f++,f===e&&(m.data=!1,d?t():l&&(l=!1,a.fetch())))});s.push(c)})(),c++;return m.map=!0,p()},o.reduce=function(e){return m.reduce?o:(a=rWorker(e,function(e){r&&(r.resolve(e),r=!1)}),m.reduce=!0,p())},o.data=function(e){return d?void 0:(u+=e.length,i=i.concat(e),m.data=!0,p())},o.fetch=function(n){return r||(r=c.deferred()),e>f&&!n?l=!0:a.fetch(),r.promise},o.close=function(){return r||(r=c.deferred()),e>f?d=!0:t(),r.promise},o}function nonIncrementalMapReduce(e){function n(){return a.data&&a.map&&a.reduce?r.close():t}var t=new Communist,r=incrementalMapReduce(e),a={data:!1,map:!1,reduce:!1};return t.map=function(e,t){return a.map=!0,r.map(e,t),n()},t.reduce=function(e){return a.reduce=!0,r.reduce(e),n()},t.data=function(e){return a.data=!0,r.data(e),n()},t}function c(e,n,t){return"number"!=typeof e&&"function"==typeof n?mapWorker(e,n,t):"object"!=typeof e||Array.isArray(e)?"number"!=typeof e?n?single(e,n):multiUse(e):"number"==typeof e?n?nonIncrementalMapReduce(e):incrementalMapReduce(e):void 0:"number"==typeof n?queue(e,n,t):object(e)}(function(attachTo,global){function isStringAndStartsWith(e,n){return"string"==typeof e&&e.substring(0,n.length)===n}function onGlobalMessage(e){if(e.source===global&&isStringAndStartsWith(e.data,MESSAGE_PREFIX)){var n=e.data.substring(MESSAGE_PREFIX.length);tasks.runIfPresent(n)}}var tasks=function(){function Task(e,n){this.handler=e,this.args=n}Task.prototype.run=function(){if("function"==typeof this.handler)this.handler.apply(void 0,this.args);else{var scriptSource=""+this.handler;eval(scriptSource)}};var nextHandle=1,tasksByHandle={},currentlyRunningATask=!1;return{addFromSetImmediateArguments:function(e){var n=e[0],t=Array.prototype.slice.call(e,1),r=new Task(n,t),a=nextHandle++;return tasksByHandle[a]=r,a},runIfPresent:function(e){if(currentlyRunningATask)global.setTimeout(function(){tasks.runIfPresent(e)},0);else{var n=tasksByHandle[e];if(n){currentlyRunningATask=!0;try{n.run()}finally{delete tasksByHandle[e],currentlyRunningATask=!1}}}},remove:function(e){delete tasksByHandle[e]}}}(),MESSAGE_PREFIX="com.communistjs.setImmediate"+Math.random();global.addEventListener?global.addEventListener("message",onGlobalMessage,!1):global.attachEvent("onmessage",onGlobalMessage),attachTo.setImmediate=function(){var e=tasks.addFromSetImmediateArguments(arguments);return global.postMessage(MESSAGE_PREFIX+e,"*"),e}})(c,window),function(e){function n(){var e=function(u,c,s){var i;if(u!==e)return i=n(),e.c.push({d:i,resolve:u,reject:c}),i.promise;for(var f,l,d,m=c?"resolve":"reject",p=0,v=e.c.length;v>p;p++)f=e.c[p],l=f.d,d=f[m],typeof d!==a?l[m](s):r(d,s,l);e=t(o,s,c)},o={then:function(n,t){return e(n,t)}};return e.c=[],{promise:o,resolve:function(n){e.c&&e(e,!0,n)},reject:function(n){e.c&&e(e,!1,n)}}}function t(e,t,o){return function(u,c){var s,i=o?u:c;return typeof i!==a?e:(r(i,t,s=n()),s.promise)}}function r(n,t,r){e.setImmediate(function(){var e;try{e=n(t),e&&typeof e.then===a?e.then(r.resolve,r.reject):r.resolve(e)}catch(o){r.reject(o)}})}var a="function";e.resolve=function(e){var n={};return n.then=t(n,e,!0),n},e.reject=function(e){var n={};return n.then=t(n,e,!1),n},e.deferred=n}(c),c.all=function(e){for(var n=c.deferred(),t=e.length,r=0,a=0,o=Array(t),u=function(e){return function(r){o[e]=r,a++,a===t&&n.resolve(o)}};t>r;)e[r].then(u(r),function(e){n.reject(e)}),r++;return n.promise};var Communist=function(){};c.reducer=rWorker,c.worker=makeWorker,c.makeUrl=function(e){var n=document.createElement("link");return n.href=e,n.href},c.ajax=function(e,n,t){var r=t?"request.responseText":"JSON.parse(request.responseText)",a=n?"("+(""+n)+")("+r+",_cb)":r,o='function (url, _cb) {\n		var request = new XMLHttpRequest();\n		request.open("GET", url);\n			request.onreadystatechange = function() {\n				var _resp;\n				if (request.readyState === 4 && request.status === 200) {\n_resp = '+a+';\n					if(typeof _resp!=="undefined"){_cb(_resp);}\n					}\n			};\n			request.onerror=function(e){throw(e);}\n		request.send();\n	}';return c(o,c.makeUrl(e))},window.communist=c}();
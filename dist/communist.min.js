/*! communist 2013-07-08*/
/*!(c)2013 Calvin Metcalf @license MIT https://github.com/calvinmetcalf/communist */
/*!Includes Promiscuous (c)2013 Ruben Verborgh @license MIT https://github.com/RubenVerborgh/promiscuous*/
/*!Includes Material from setImmediate Copyright (c) 2012 Barnesandnoble.com, llc, Donavon West, and Domenic Denicola @license MIT https://github.com/NobleJS/setImmediate */
"undefined"==typeof document?(self._noTransferable=!0,self.onmessage=function(e){eval(e.data)}):function(global){"use strict";function moveImports(e){var n,t=e.match(/(importScripts\(.*?\);)/);return n=t?t[0].replace(/importScripts\((.*?\.js[\'\"])\);?/,function(e,n){return n?"importScripts("+n.split(",").map(function(e){return e.slice(0,1)+c.makeUrl(e.slice(1,-1))+e.slice(-1)})+");\n":""})+e.replace(/(importScripts\(.*?\.js[\'\"]\);?)/,"\n"):e}function getPath(){if("undefined"!=typeof SHIM_WORKER_PATH)return SHIM_WORKER_PATH;for(var e=document.getElementsByTagName("script"),n=e.length,t=0;n>t;){if(/communist(\.min)?\.js/.test(e[t].src))return e[t].src;t++}}function makeWorker(e){var n,t=moveImports(e.join(""));c.URL=c.URL||window.URL||window.webkitURL;try{n=new Worker(c.URL.createObjectURL(new Blob([t],{type:"text/javascript"})))}catch(r){c._noTransferable=!0,n=new Worker(getPath()),n.postMessage(t)}finally{return n}}function single(e,n){if("undefined"==typeof Worker)return multiUse(e).data(n);var t=c.deferred(),r=makeWorker(["var _self = {};_self.fun = ",e,";_self.cb = function (data, transfer) {	!self._noTransferable ? self.postMessage(data, transfer) : self.postMessage(data);	self.close();};_self.result = _self.fun(",JSON.stringify(n),', _self.cb);if (typeof _self.result !== "undefined") {	_self.cb(_self.result);}']);return r.onmessage=function(e){t.resolve(e.data)},r.onerror=function(e){e.preventDefault(),t.reject(e.message)},t.promise}function mapWorker(e,n,t){if("undefined"==typeof Worker)return fakeMapWorker(e,n,t);var r=new Communist,a=makeWorker(["var _db = {};_db.__close__ = function () {	self.close();};var _self = {};_db.__fun__ = ",e,';_self.cb = function (data, transfer) {	!self._noTransferable ? self.postMessage(data, transfer) : self.postMessage(data);};self.onmessage = function (e) {	_self.result = _db.__fun__(e.data, _self.cb);	if (typeof _self.result !== "undefined") {		_self.cb(_self.result);	}}']);return a.onmessage=function(e){n(e.data)},a.onerror=t?t:function(){n()},r.data=function(e,n){return c._noTransferable?a.postMessage(e):a.postMessage(e,n),r},r.close=function(){return a.terminate()},r}function multiUse(e){return object({data:e})}function fakeObject(e){var n=new Communist,t=[];"initialize"in e||(e.initialize=function(){});var r=function(n){var r,a=function(a){var o=t.length;t[o]=c.deferred();var u=function(e){t[o].resolve(e)};try{r=e[n](a,u),r!==void 0&&u(r)}catch(s){t[o].reject(s)}return t[o].promise};return a};for(var a in e)n[a]=r(a);return n._close=function(){return c.resolve()},"close"in n||(n.close=n._close),n.initialize(),n}function fakeMapWorker(e,n,t){var r=new Communist,a=fakeObject({data:e});return r.data=function(e){return a.data(e).then(n,t),r},r.close=a.close,r}function fakeReducer(e,n){var t,r=new Communist;return r.data=function(n){return t=t?e(t,n):n,r},r.fetch=function(){return n(t),r},r.close=function(e){e||n(t)},r}function object(e){if("undefined"==typeof Worker)return fakeObject(e);var n=new Communist,t=0,r=[],a=function(e){"string"!=typeof e&&e.preventDefault&&(e.preventDefault(),e=e.message),r.forEach(function(n){n&&n.reject(e)})};"initialize"in e||(e.initialize=function(){});var o="{",u=function(e){var n=function(n,t){var a=r.length;return r[a]=c.deferred(),c._noTransferable?i.postMessage([a,e,n]):i.postMessage([a,e,n],t),r[a].promise};return n};for(var s in e)0!==t?o+=",":t++,o=o+s+":"+(""+e[s]),n[s]=u(s);o+="}";var i=makeWorker(["var _db=",o,';self.onmessage=function(e){	var cb=function(data,transfer){		!self._noTransferable?self.postMessage([e.data[0],data],transfer):self.postMessage([e.data[0],data]);	};	var result = _db[e.data[1]](e.data[2],cb);	if(typeof result !== "undefined"){		cb(result);	}};_db.initialize();']);return i.onmessage=function(e){r[e.data[0]].resolve(e.data[1]),r[e.data[0]]=0},i.onerror=a,n._close=function(){return i.terminate(),a("closed"),c.resolve()},"close"in n||(n.close=n._close),n}function queue(e,n,t){function r(e){e=e||"canceled",b=0;var n=v;return v=[],n.forEach(function(n){n[3].reject(e)}),!0}function a(e){return function(n,t){return l(e,n,t)}}function o(e){return function(n){return c.all(n.map(function(n){return l(e,n)}))}}function u(e){return function(n){var t=this;return c.all(n.map(function(n){return l(e,n).then(t.__cb__)}))}}function s(e){return function(n){return c.all(n.map(function(n){return l(e,n[0],n[1])}))}}function i(e){return function(n){var t=this;return c.all(n.map(function(n){return l(e,n[0],n[1]).then(t.__cb__)}))}}function f(e){var n;b?(n=v.shift(),b--,m[e][n[0]](n[1],n[2]).then(function(t){f(e),n[3].resolve(t)},function(t){f(e),n[3].reject(t)})):(p++,_.push(e))}function l(e,r,a){if(t)return m[~~(Math.random()*n)][e](r,a);var o,u=c.deferred();return!b&&p?(o=_.pop(),p--,m[o][e](r,a).then(function(e){f(o),u.resolve(e)},function(e){f(o),u.reject(e)})):(b||!p)&&(b=v.push([e,r,a,u])),u.promise}var d=new Communist;d.__batchcb__=new Communist,d.__batchtcb__=new Communist,d.batch=function(e){return"function"==typeof e?(d.__batchcb__.__cb__=e,d.__batchcb__):r(e)},d.batchTransfer=function(e){return"function"==typeof e?(d.__batchtcb__.__cb__=e,d.__batchtcb__):r(e)};for(var m=Array(n),p=0,_=[],v=[],b=0;n>p;)m[p]=object(e),_.push(p),p++;for(var h in e)d[h]=a(h),d.batch[h]=o(h),d.__batchcb__[h]=u(h),d.batchTransfer[h]=s(h),d.__batchtcb__[h]=i(h);return d._close=function(){return c.all(m.map(function(e){return e._close()}))},"close"in d||(d.close=d._close),d}function rWorker(e,n){if("undefined"==typeof Worker)return fakeReducer(e,n);var t=new Communist,r=["function (dat, cb) {	var fun = ",e,';	switch (dat[0]) {	case "data":		if (!this._r) {			this._r = dat[1];		}		else {			this._r = fun(this._r, dat[1]);		}		break;	case "get":		return cb(this._r);	case "close":		cb(this._r);		this.__close__();		break;	}};'],a=function(e){n(e)},o=mapWorker(r.join(""),a);return t.data=function(e,n){return c._noTransferable?o.data(["data",e]):o.data(["data",e],n),t},t.fetch=function(){return o.data(["get"]),t},t.close=function(e){e&&(n=function(){}),o.data(["close"])},t}function incrementalMapReduce(e){function n(){for(var e=0,n=s.length;n>e&&u>0&&f>0;)u--,s[e].data(i.pop()),e++,f--;return o}function t(){a.close(),s.forEach(function(e){e.close()})}var r,a,o=new Communist,u=0,s=[],i=[],f=e,l=!1,d=!1,m={map:!1,reduce:!1,data:!1},p=function(){return m.map&&m.reduce&&m.data?n():o};return o.map=function(n,r){function c(){var o,c=mapWorker(n,function(n){void 0!==typeof n&&a.data(n),u>0?(u--,o=i.pop(),r?c.data(o,[o]):c.data(o)):(f++,f===e&&(m.data=!1,d?t():l&&(l=!1,a.fetch())))});s.push(c)}if(m.map)return o;for(var _=0;e>_;)c(),_++;return m.map=!0,p()},o.reduce=function(e){return m.reduce?o:(a=rWorker(e,function(e){r&&(r.resolve(e),r=!1)}),m.reduce=!0,p())},o.data=function(e){return d?void 0:(u+=e.length,i=i.concat(e),m.data=!0,p())},o.fetch=function(n){return r||(r=c.deferred()),e>f&&!n?l=!0:a.fetch(),r.promise},o.close=function(){return r||(r=c.deferred()),e>f?d=!0:t(),r.promise},o}function nonIncrementalMapReduce(e){function n(){return a.data&&a.map&&a.reduce?r.close():t}var t=new Communist,r=incrementalMapReduce(e),a={data:!1,map:!1,reduce:!1};return t.map=function(e,t){return a.map=!0,r.map(e,t),n()},t.reduce=function(e){return a.reduce=!0,r.reduce(e),n()},t.data=function(e){return a.data=!0,r.data(e),n()},t}function c(e,n,t){return"number"!=typeof e&&"function"==typeof n?mapWorker(e,n,t):"object"!=typeof e||Array.isArray(e)?"number"!=typeof e?n?single(e,n):multiUse(e):"number"==typeof e?n?nonIncrementalMapReduce(e):incrementalMapReduce(e):void 0:"number"==typeof n?queue(e,n,t):object(e)}function initBrowser(e){var n=global.cw;e.noConflict=function(){global.cw=n},global.communist=e,global.cw=e}(function(attachTo,global){function isStringAndStartsWith(e,n){return"string"==typeof e&&e.substring(0,n.length)===n}function onGlobalMessage(e){if(e.source===global&&isStringAndStartsWith(e.data,MESSAGE_PREFIX)){var n=e.data.substring(MESSAGE_PREFIX.length);tasks.runIfPresent(n)}}var tasks=function(){function Task(e,n){this.handler=e,this.args=n}Task.prototype.run=function(){if("function"==typeof this.handler)this.handler.apply(void 0,this.args);else{var scriptSource=""+this.handler;eval(scriptSource)}};var nextHandle=1,tasksByHandle={},currentlyRunningATask=!1;return{addFromSetImmediateArguments:function(e){var n=e[0],t=Array.prototype.slice.call(e,1),r=new Task(n,t),a=nextHandle++;return tasksByHandle[a]=r,a},runIfPresent:function(e){if(currentlyRunningATask)global.setTimeout(function(){tasks.runIfPresent(e)},0);else{var n=tasksByHandle[e];if(n){currentlyRunningATask=!0;try{n.run()}finally{delete tasksByHandle[e],currentlyRunningATask=!1}}}},remove:function(e){delete tasksByHandle[e]}}}(),MESSAGE_PREFIX="com.communistjs.setImmediate"+Math.random();global.addEventListener?global.addEventListener("message",onGlobalMessage,!1):global.attachEvent("onmessage",onGlobalMessage),attachTo.setImmediate=function(){var e=tasks.addFromSetImmediateArguments(arguments);return global.postMessage(MESSAGE_PREFIX+e,"*"),e}})(c,global),function(e){function n(){var e=function(c,u,s){var i;if(c!==e)return i=n(),e.c.push({d:i,resolve:c,reject:u}),i.promise;for(var f,l,d,m=u?"resolve":"reject",p=0,_=e.c.length;_>p;p++)f=e.c[p],l=f.d,d=f[m],typeof d!==a?l[m](s):r(d,s,l);e=t(o,s,u)},o={then:function(n,t){return e(n,t)}};return e.c=[],{promise:o,resolve:function(n){e.c&&e(e,!0,n)},reject:function(n){e.c&&e(e,!1,n)}}}function t(e,t,o){return function(c,u){var s,i=o?c:u;return typeof i!==a?e:(r(i,t,s=n()),s.promise)}}function r(n,t,r){e.setImmediate(function(){var e;try{e=n(t),e&&typeof e.then===a?e.then(r.resolve,r.reject):r.resolve(e)}catch(o){r.reject(o)}})}var a="function";e.resolve=function(e){var n={};return n.then=t(n,e,!0),n},e.reject=function(e){var n={};return n.then=t(n,e,!1),n},e.deferred=n}(c),c.all=function(e){var n=c.deferred(),t=e.length,r=0,a=Array(t),o=function(e){return function(o){a[e]=o,r++,r===t&&n.resolve(a)}};return e.forEach(function(e,t){e.then(o(t),function(e){n.reject(e)})}),n.promise};var Communist=function(){};c.reducer=rWorker,c.worker=makeWorker,c.makeUrl=function(e){var n=document.createElement("link");return n.href=e,n.href},c.ajax=function(e,n,t){var r=t?"request.responseText":"JSON.parse(request.responseText)",a=n?"("+(""+n)+")("+r+",_cb)":r,o='function (url, _cb) {\n		var request = new XMLHttpRequest();\n		request.open("GET", url);\n			request.onreadystatechange = function() {\n				var _resp;\n				if (request.readyState === 4 && request.status === 200) {\n_resp = '+a+';\n					if(typeof _resp!=="undefined"){_cb(_resp);}\n					}\n			};\n			request.onerror=function(e){throw(e);}\n		request.send();\n	}';return c(o,c.makeUrl(e))},"undefined"==typeof module?initBrowser(c):module.exports=c}(this);
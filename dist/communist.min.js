/*! communist 2013-04-02*/
/*!©2013 Calvin Metcalf @license MIT https://github.com/calvinmetcalf/communist */
/*!Includes Promiscuous ©2013 Ruben Verborgh @license MIT https://github.com/RubenVerborgh/promiscuous*/
(function(){"use strict";function n(){return i.deferred()}function e(n){var e,t=n.match(/(importScripts\(.*\);)/);return e=t?t[0].replace(/importScripts\((.*)\);?/,function(n,e){return e?"importScripts("+e.split(",").map(function(n){return'"'+i.makeUrl(n.slice(1,-1))+'"'})+");\n":""})+n.replace(/(importScripts\(.*\);?)/,"\n"):n}function t(n){var t,r=e(n.join(""));if(i.URL=i.URL||window.URL||window.webkitURL||self.URL,window.communist.IEpath){try{t=new Worker(i.URL.createObjectURL(new Blob([r],{type:"text/javascript"})))}catch(a){t=new Worker(window.communist.IEpath),t.postMessage(r)}return t}return new Worker(i.URL.createObjectURL(new Blob([r],{type:"text/javascript"})))}function r(e,r){var a=n(),u=t(["var _self={};\n_self.fun = ",e,";\n	_self.cb=function(data,transfer){\n			self.postMessage(data,transfer);\n			self.close();\n		};\n		_self.result = _self.fun(",JSON.stringify(r),',_self.cb);\n		if(typeof _self.result !== "undefined"){\n			_self.cb(_self.result);\n		}']);return u.onmessage=function(n){a.resolve(n.data)},u.onerror=function(n){n.preventDefault(),a.reject(n.message)},a.promise}function a(n,e,r){var a=new Communist,u=t(["var _close=function(){self.close();};var _db={};\nvar _self={};\n_self.fun = ",n,';\n		_self.cb=function(data,transfer){\n			self.postMessage(data,transfer);\n		};\n		self.onmessage=function(e){\n		_self.result = _self.fun(e.data,_self.cb);\n			if(typeof _self.result !== "undefined"){\n				_self.cb(_self.result);\n			}\n		}']);return u.onmessage=function(n){e(n.data)},u.onerror=r?r:function(){e()},a.data=function(n,e){return u.postMessage(n,e),a},a.close=function(){return u.terminate()},a}function u(e){var t=new Communist,r=[],u=function(n){"string"!=typeof n&&n.preventDefault&&(n.preventDefault(),n=n.message),r.forEach(function(e){e&&e.reject(n)})},o="function(data,cb){_self.func = "+e+';\n		_self.numberCB = function(num,d,tran){\n			cb([num,d],tran);\n		};\n		_self.boundCB = _self.numberCB.bind(null,data[0]);\n		_self.result = _self.func(data[1],_self.boundCB);\n		if(typeof _self.result !== "undefined"){\n			_self.boundCB(_self.result);\n		}\n	}',c=function(n){r[n[0]].resolve(n[1]),r[n[0]]=0},f=a(o,c,u);return t.close=function(){f.close(),u("closed")},t.data=function(e,t){var a=r.length;return r[a]=n(),f.data([a,e],t),r[a].promise},t}function o(n,e){var t=new Communist,r="function(dat,cb){ var fun = "+n+';\n		switch(dat[0]){\n			case "data":\n				if(!_db._r){\n					_db._r = dat[1];\n				}else{\n					_db._r = fun(_db._r,dat[1]);\n				}\n				break;\n			case "get":\n				return cb(_db._r);\n			case "close":\n				cb(_db._r);\n				_close();\n				break;\n		}\n	};',u=function(n){e(n)},o=a(r,u);return t.data=function(n,e){return o.data(["data",n],e),t},t.fetch=function(){return o.data(["get"]),t},t.close=function(n){n&&(e=function(){}),o.data(["close"])},t}function c(e){function t(){for(var n=0,e=i.length;e>n&&s>0&&d>0;)s--,i[n].data(l.pop()),n++,d--;return f}function r(){c.close(),i.forEach(function(n){n.close()})}var u,c,f=new Communist,s=0,i=[],l=[],d=e,p=!1,_=!1,v={map:!1,reduce:!1,data:!1},m=function(){return v.map&&v.reduce&&v.data?t():f};return f.map=function(n,t){if(v.map)return f;for(var u=0;e>u;)(function(){var u,o=a(n,function(n){void 0!==typeof n&&c.data(n),s>0?(s--,u=l.pop(),t?o.data(u,[u]):o.data(u)):(d++,d===e&&(v.data=!1,_?r():p&&(p=!1,c.fetch())))});i.push(o)})(),u++;return v.map=!0,m()},f.reduce=function(n){return v.reduce?f:(c=o(n,function(n){u&&(u.resolve(n),u=!1)}),v.reduce=!0,m())},f.data=function(n){return _?void 0:(s+=n.length,l=l.concat(n),v.data=!0,m())},f.fetch=function(t){return u||(u=n()),e>d&&!t?p=!0:c.fetch(),u.promise},f.close=function(){return u||(u=n()),e>d?_=!0:r(),u.promise},f}function f(n){function e(){return a.data&&a.map&&a.reduce?r.close():t}var t=new Communist,r=c(n),a={data:!1,map:!1,reduce:!1};return t.map=function(n,t){return a.map=!0,r.map(n,t),e()},t.reduce=function(n){return a.reduce=!0,r.reduce(n),e()},t.data=function(n){return a.data=!0,r.data(n),e()},t}function s(n){var e=new Communist;Object.keys(n);var t=0,r="{",a=function(n){var e=function(){var e=Array.prototype.slice.call(arguments);return f.data([n,e])};return e};for(var o in n)0!==t?r+=",":t++,r=r+o+":"+(""+n[o]),e[o]=a(o);r+="}";var c='function(data,cb){\n		var cont;\n		if(data[0]==="__start__"){\n			_self.obj = '+r+";\n			return true;\n		}\n		else{\n		cont =data[1];\n		cont.push(cb);\n		return _self.obj[data[0]].apply(null,cont);\n		}\n	}",f=u(c);return e._close=f.close,f.data(["__start__"]),e}function i(n,e,t){return"number"!=typeof n&&"function"==typeof e?a(n,e,t):"object"!=typeof n||Array.isArray(n)?"number"!=typeof n?e?r(n,e):u(n):"number"==typeof n?e?f(n):c(n):void 0:s(n)}(function(n){function e(){var n,o,c={then:function(e,t){return n(e,t)}};return function(){var f=[];n=function(n,t){var r=e();return f.push({d:r,resolve:n,reject:t}),r.promise},o=function(e,s,i){for(var l=0,d=f.length;d>l;l++){var p=f[l],_=p.d,v=p[e];typeof v!==a?_[e](s):r(v,s,_)}n=t(c,s,i),o=u}}(),{resolve:function(n){o("resolve",n,!0)},reject:function(n){o("reject",n,!1)},promise:c}}function t(n,t,u){return function(o,c){var f,s=u?o:c;return typeof s!==a?n:(setTimeout(r.bind(n,s,t,f=e())),f.promise)}}function r(n,e,t){try{var r=n(e);r&&typeof r.then===a?r.then(t.resolve,t.reject):t.resolve(r)}catch(u){t.reject(u)}}var a="function",u=function(){};n.resolve=function(n){var e={};return e.then=t(e,n,!0),e},n.reject=function(n){var e={};return e.then=t(e,n,!1),e},n.deferred=e})(i);var Communist=function(){};i.reducer=o,i.worker=t,i.makeUrl=function(n){var e=document.createElement("link");return e.href=n,e.href},i.ajax=function(n,e,t){var r=t?"request.responseText":"JSON.parse(request.responseText)",a=e?"("+(""+e)+")("+r+",_cb)":r,u='function (url, _cb) {\n		var request = new XMLHttpRequest();\n		request.open("GET", url);\n			request.onreadystatechange = function() {\n				var _resp;\n				if (request.readyState === 4 && request.status === 200) {\n_resp = '+a+';\n					if(typeof _resp!=="undefined"){_cb(_resp);}\n					}\n			};\n		request.send();\n	}';return i(u,i.makeUrl(n))},window.communist=i})();
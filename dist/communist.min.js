/*! communist 2.2.0 2013-08-05*/
/*!(c)2013 Calvin Metcalf @license MIT https://github.com/calvinmetcalf/communist */
/*!Includes Promiscuous (c)2013 Ruben Verborgh @license MIT https://github.com/RubenVerborgh/promiscuous*/
/*!Includes Material from setImmediate Copyright (c) 2012 Barnesandnoble.com, llc, Donavon West, and Domenic Denicola @license MIT https://github.com/NobleJS/setImmediate */
"undefined"==typeof document?(self._noTransferable=!0,self.onmessage=function(e){eval(e.data)}):function(global){"use strict";function regexImports(a){for(var b=a,c=!0,d={},e=function(a,b){b&&"importScripts("+b.split(",").forEach(function(a){d[communist.makeUrl(a.match(/\s*[\'\"](\S*)[\'\"]\s*/)[1])]=!0})+");\n"};c;)c=b.match(/(importScripts\(.*?\);?)/),b=b.replace(/(importScripts\(\s*(?:[\'\"].*?[\'\"])?\s*\);?)/,"\n"),c&&c[0].replace(/importScripts\(\s*([\'\"].*?[\'\"])?\s*\);?/g,e);return d=Object.keys(d),[d,b]}function moveImports(a){var b=regexImports(a),c=b[0],d=b[1];return c.length>0?'importScripts("'+c.join('","')+'");\n'+d:d}function moveIimports(a){var b=regexImports(a),c=b[0],d=b[1];return c.length>0?'importScripts("'+c.join('","')+'");eval(__scripts__);\n'+d:d}function getPath(){if("undefined"!=typeof SHIM_WORKER_PATH)return SHIM_WORKER_PATH;for(var a=document.getElementsByTagName("script"),b=a.length,c=0;b>c;){if(/communist(\.min)?\.js/.test(a[c].src))return a[c].src;c++}}function appendScript(a,b){var c=a.createElement("script");void 0!==c.text?c.text=b:c.innerHTML=b,"complete"===a.readyState?a.documentElement.appendChild(c):a.onreadystatechange=function(){"complete"===a.readyState&&a.documentElement.appendChild(c)}}function actualMakeI(a,b){var c=document.createElement("iframe");c.style.display="none",document.body.appendChild(c);var d=c.contentWindow,e=d.document,f=["try{ ",'var __scripts__="";function importScripts(scripts){',"	if(Array.isArray(scripts)&&scripts.length>0){","		scripts.forEach(function(url){","			var ajax = new XMLHttpRequest();",'			ajax.open("GET",url,false);',"			ajax.send();__scripts__+=ajax.responseText;",'			__scripts__+="\\n;";',"		});","	}","};",a,"}catch(e){",'	window.parent.postMessage(["'+b+'","error"],"*")',"}"].join("\n");return appendScript(e,f),c}function makeIframe(a,b){var c=communist.deferred();return"complete"===document.readyState?c.resolve(actualMakeI(a,b)):window.addEventListener("load",function(){c.resolve(actualMakeI(a,b))},!1),c.promise}function communist(a,b,c){return 1===arguments.length||!b||1>=b?new communist.Worker(a):new communist.Queue(a,b,c)}function initBrowser(a){var b=global.cw;a.noConflict=function(c){global.cw=b,c&&(global[c]=a)},global.communist=a,global.cw=a}!function(attachTo,global){function isStringAndStartsWith(a,b){return"string"==typeof a&&a.substring(0,b.length)===b}function onGlobalMessage(a){if(a.source===global&&isStringAndStartsWith(a.data,MESSAGE_PREFIX)){var b=a.data.substring(MESSAGE_PREFIX.length);tasks.runIfPresent(b)}}var tasks=function(){function Task(a,b){this.handler=a,this.args=b}Task.prototype.run=function(){if("function"==typeof this.handler)this.handler.apply(void 0,this.args);else{var scriptSource=""+this.handler;eval(scriptSource)}};var nextHandle=1,tasksByHandle={},currentlyRunningATask=!1;return{addFromSetImmediateArguments:function(a){var b=a[0],c=Array.prototype.slice.call(a,1),d=new Task(b,c),e=nextHandle++;return tasksByHandle[e]=d,e},runIfPresent:function(a){if(currentlyRunningATask)global.setTimeout(function(){tasks.runIfPresent(a)},0);else{var b=tasksByHandle[a];if(b){currentlyRunningATask=!0;try{b.run()}finally{delete tasksByHandle[a],currentlyRunningATask=!1}}}},remove:function(a){delete tasksByHandle[a]}}}(),MESSAGE_PREFIX="com.communistjs.setImmediate"+Math.random();global.addEventListener?global.addEventListener("message",onGlobalMessage,!1):global.attachEvent("onmessage",onGlobalMessage),attachTo.setImmediate=function(){var a=tasks.addFromSetImmediateArguments(arguments);return global.postMessage(MESSAGE_PREFIX+a,"*"),a}}(communist,global),function(a,b){function Deferred(){function Promise(){this.then=function(b,c){return a(b,c)}}var a=function(g,h,i){var j;if(g!==a)return j=c(),a.queue.push({deferred:j,resolve:g,reject:h}),j.promise;for(var k,l,m,n=h?"resolve":"reject",o=0,p=a.queue.length;p>o;o++)k=a.queue[o],l=k.deferred,m=k[n],typeof m!==f?l[n](i):e(m,i,l);a=d(b,i,h)},b=new Promise;this.promise=b,a.queue=[],this.resolve=function(b){a.queue&&a(a,!0,b)},this.reject=function(b){a.queue&&a(a,!1,b)}}function c(){return new Deferred}function d(a,b,d){return function(g,h){var i,j=d?g:h;return typeof j!==f?a:(e(j,b,i=c()),i.promise)}}function e(a,c,d){b(function(){var b;try{b=a(c),b&&typeof b.then===f?b.then(d.resolve,d.reject):d.resolve(b)}catch(e){d.reject(e)}})}var f="function";a.resolve=function(a){var b={};return b.then=d(b,a,!0),b},a.reject=function(a){var b={};return b.then=d(b,a,!1),b},a.deferred=c,a.all=function(b){var c=a.deferred(),d=b.length,e=0,f=[],g=function(a){return function(b){f[a]=b,e++,e===d&&c.resolve(f)}};return b.forEach(function(a,b){a.then(g(b),function(a){c.reject(a)})}),c.promise}}(communist,communist.setImmediate),communist._hasWorker="undefined"!=typeof Worker&&"undefined"==typeof fakeLegacy,communist.makeIWorker=function(a,b){var c=moveIimports(a.join("")),d={onmessage:function(){}},e=makeIframe(c,b);return window.addEventListener("message",function(a){"string"==typeof a.data&&a.data.length>b.length&&a.data.slice(0,b.length)===b&&d.onmessage({data:JSON.parse(a.data.slice(b.length))})}),d.postMessage=function(a){e.then(function(b){b.contentWindow.postMessage(JSON.stringify(a),"*")})},d.terminate=function(){e.then(function(a){document.body.removeChild(a)})},d},communist.makeWorker=function(a,b){if(!communist._hasWorker)return communist.makeIWorker(a,b);var c,d=moveImports(a.join(""));communist.URL=communist.URL||window.URL||window.webkitURL;try{c=new Worker(communist.URL.createObjectURL(new Blob([d],{type:"text/javascript"})))}catch(e){communist._noTransferable=!0,c=new Worker(getPath()),c.postMessage(d)}finally{return c}},communist.makeUrl=function(a){var b=document.createElement("link");return b.href=a,b.href},communist.Worker=function(a){function b(a,c){return a.indexOf(" ")>0?(a.split(" ").forEach(function(a){b(a,c)}),e):a in d?(d[a].forEach(function(a){a(c)}),e):e}"function"==typeof a&&(a={data:a});var c="com.communistjs."+(communist._hasWorker?"iframe":"worker")+Math.random(),d={},e=this;e.on=function(a,b,c){return c=c||e,a.indexOf(" ")>0?(a.split(" ").map(function(a){return e.on(a,b,c)},this),e):(a in d||(d[a]=[]),d[a].push(function(a){b.call(c,a)}),e)},e.fire=function(a,b,c){return communist._noTransferable?l.postMessage([[a],b]):l.postMessage([[a],b],c),e},e.off=function(a,b){return a.indexOf(" ")>0?(a.split(" ").map(function(a){return e.off(a,b)}),e):a in d?(b?d[a].indexOf(b)>-1&&(d[a].length>1?delete d[a]:d[a].splice(d[a].indexOf(b),1)):delete d[a],e):e};var f=0,g=[],h=function(a){"string"!=typeof a&&"preventDefault"in a&&(a.preventDefault(),a=a.message),g.forEach(function(b){b&&b.reject(a)})};a.__codeWord__='"'+c+'"',"initialize"in a||(a.initialize="init"in a?a.init:function(){});var i="{\n	",j=function(a){var b=function(b,d){var e=g.length;return g[e]=communist.deferred(),communist._noTransferable?l.postMessage([[c,e],a,b]):l.postMessage([[c,e],a,b],d),g[e].promise};return b};for(var k in a)0!==f?i+=",\n		":f++,i=i+k+":"+a[k].toString(),e[k]=j(k);i+="}";var l=communist.makeWorker(["var _db = ",i,';\nvar listeners = {};\nvar __iFrame__ = typeof document!=="undefined";\nvar __self__={onmessage:function(e){\n	_fire("messege",e.data[1]);\n	if(e.data[0][0]===_db.__codeWord__){\n		return regMsg(e);\n	}else{\n		_fire(e.data[0][0],e.data[1]);\n	}\n}};\n\nif(__iFrame__){\n	window.onmessage=function(e){\n		if(typeof e.data === "string"){\n			e ={data: JSON.parse(e.data)};\n		}\n		__self__.onmessage(e);\n	};\n}else{\n	self.onmessage=__self__.onmessage;\n}\n__self__.postMessage=function(rawData, transfer){\n	var data;\n	if(!self._noTransferable&&!__iFrame__){\n		self.postMessage(rawData, transfer);\n	}else if(__iFrame__){\n		data = _db.__codeWord__+JSON.stringify(rawData);\n		window.parent.postMessage(data,"*");\n	}else if(!self._noTransferable){\n		self.postMessage(rawData);\n	}\n};\n_db.on = function (eventName, func, scope) {\n	if(eventName.indexOf(" ")>0){\n		return eventName.split(" ").map(function(v){\n			return _db.on(v,func,scope);\n		},_db);\n	}\n	scope = scope || _db;\n	if (!(eventName in listeners)) {\n		listeners[eventName] = [];\n	}\n	listeners[eventName].push(function (a) {\n		func.call(scope, a, _db);\n	});\n};\nfunction _fire(eventName,data){\n	if(eventName.indexOf(" ")>0){\n		eventName.split(" ").forEach(function(v){\n			_fire(v,data);\n		});\n		return;\n	}\n	if (!(eventName in listeners)) {\n		return;\n	}\n	listeners[eventName].forEach(function (v) {\n		v(data);\n	});\n}\n\n_db.fire = function (eventName, data, transfer) {\n	__self__.postMessage([[eventName], data], transfer);\n};\n_db.off=function(eventName,func){\n	if(eventName.indexOf(" ")>0){\n		return eventName.split(" ").map(function(v){\n			return _db.off(v,func);\n		});\n	}\n	if(!(eventName in listeners)){\n		return;\n	}else if(!func){\n		delete listeners[eventName];\n	}else{\n		if(listeners[eventName].indexOf(func)>-1){\n			if(listeners[eventName].length>1){\n				delete listeners[eventName];\n			}else{\n				listeners[eventName].splice(listeners[eventName].indexOf(func),1);\n			}\n		}\n	}\n};\nvar console={};\nfunction makeConsole(method){\n	return function(){\n		var len = arguments.length;\n		var out =[];\n		var i = 0;\n		while (i<len){\n			out.push(arguments[i]);\n			i++;\n		}\n		_db.fire("console",[method,out]);\n	};\n}\n["log", "debug", "error", "info", "warn", "time", "timeEnd"].forEach(function(v){\n	console[v]=makeConsole(v);\n});\nvar regMsg = function(e){\n	var cb=function(data,transfer){\n		__self__.postMessage([e.data[0],data],transfer);\n	};\n	var result;\n	if(__iFrame__){\n		try{\n			result = _db[e.data[1]](e.data[2],cb,_db);\n		}catch(e){\n			_db.fire("error",JSON.stringify(e));\n		}\n	}else{\n		result = _db[e.data[1]](e.data[2],cb,_db);\n	}\n	if(typeof result !== "undefined"){\n		cb(result);\n	}\n};\n_db.initialize(_db);\n'],c);l.onmessage=function(a){b("message",a.data[1]),a.data[0][0]===c?(g[a.data[0][1]].resolve(a.data[1]),g[a.data[0][1]]=0):b(a.data[0][0],a.data[1])},e.on("error",h),l.onerror=function(a){b("error",a)},e.on("console",function(a){console[a[0]].apply(console,a[1])}),e._close=function(){return l.terminate(),h("closed"),communist.resolve()},"close"in e||(e.close=e._close)},communist.worker=function(a){return new communist.Worker(a)},communist.Queue=function(a,b,c){function d(a){a=a||"canceled",q=0;var b=p;return p=[],b.forEach(function(b){b[3].reject(a)}),l}function e(a){return function(b,c){return k(a,b,c)}}function f(a){return function(b){return communist.all(b.map(function(b){return k(a,b)}))}}function g(a){return function(b){var c=this;return communist.all(b.map(function(b){return k(a,b).then(c.__cb__)}))}}function h(a){return function(b){return communist.all(b.map(function(b){return k(a,b[0],b[1])}))}}function i(a){return function(b){var c=this;return communist.all(b.map(function(b){return k(a,b[0],b[1]).then(c.__cb__)}))}}function j(a){var b;q?(b=p.shift(),q--,m[a][b[0]](b[1],b[2]).then(function(c){j(a),b[3].resolve(c)},function(c){j(a),b[3].reject(c)})):(n++,o.push(a))}function k(a,d,e){if(c)return m[~~(Math.random()*b)][a](d,e);var f,g=communist.deferred();return!q&&n?(f=o.pop(),n--,m[f][a](d,e).then(function(a){j(f),g.resolve(a)},function(a){j(f),g.reject(a)})):(q||!n)&&(q=p.push([a,d,e,g])),g.promise}var l=this;l.__batchcb__={},l.__batchtcb__={},l.batch=function(a){return"function"==typeof a?(l.__batchcb__.__cb__=a,l.__batchcb__):d(a)},l.batchTransfer=function(a){return"function"==typeof a?(l.__batchtcb__.__cb__=a,l.__batchtcb__):d(a)};for(var m=new Array(b),n=0,o=[],p=[],q=0;b>n;)m[n]=new communist.Worker(a),o.push(n),n++;l.on=function(a,b,c){return m.forEach(function(d){d.on(a,b,c)}),l},l.off=function(a,b,c){return m.forEach(function(d){d.off(a,b,c)}),l};var r=function(a,b){return m.forEach(function(c){c.fire(a,b)}),l};l.fire=function(a,c){return m[~~(Math.random()*b)].fire(a,c),l},l.batch.fire=r,l.batchTransfer.fire=r;for(var s in a)l[s]=e(s),l.batch[s]=f(s),l.__batchcb__[s]=g(s),l.batchTransfer[s]=h(s),l.__batchtcb__[s]=i(s);l._close=function(){return communist.all(m.map(function(a){return a._close()}))},"close"in l||(l.close=l._close)},communist.queue=function(a,b,c){return new communist.Queue(a,b,c)},"undefined"!=typeof module&&"exports"in module?module.exports=communist:initBrowser(communist),communist.version="2.2.0"}(this);
/*! communist 2013-07-08*/
/*!(c)2013 Calvin Metcalf @license MIT https://github.com/calvinmetcalf/communist */
/*!Includes Promiscuous (c)2013 Ruben Verborgh @license MIT https://github.com/RubenVerborgh/promiscuous*/
/*!Includes Material from setImmediate Copyright (c) 2012 Barnesandnoble.com, llc, Donavon West, and Domenic Denicola @license MIT https://github.com/NobleJS/setImmediate */
"undefined"==typeof document?(self._noTransferable=!0,self.onmessage=function(e){eval(e.data)}):function(global){"use strict";function moveImports(a){var b,d=a.match(/(importScripts\(.*?\);)/);return b=d?d[0].replace(/importScripts\((.*?\.js[\'\"])\);?/,function(a,b){return b?"importScripts("+b.split(",").map(function(a){return a.slice(0,1)+c.makeUrl(a.slice(1,-1))+a.slice(-1)})+");\n":""})+a.replace(/(importScripts\(.*?\.js[\'\"]\);?)/,"\n"):a}function getPath(){if("undefined"!=typeof SHIM_WORKER_PATH)return SHIM_WORKER_PATH;for(var a=document.getElementsByTagName("script"),b=a.length,c=0;b>c;){if(/communist(\.min)?\.js/.test(a[c].src))return a[c].src;c++}}function makeWorker(a){var b,d=moveImports(a.join(""));c.URL=c.URL||window.URL||window.webkitURL;try{b=new Worker(c.URL.createObjectURL(new Blob([d],{type:"text/javascript"})))}catch(e){c._noTransferable=!0,b=new Worker(getPath()),b.postMessage(d)}finally{return b}}function single(a,b){if("undefined"==typeof Worker)return multiUse(a).data(b);var d=c.deferred(),e=makeWorker(["var _self = {};_self.fun = ",a,";_self.cb = function (data, transfer) {	!self._noTransferable ? self.postMessage(data, transfer) : self.postMessage(data);	self.close();};_self.result = _self.fun(",JSON.stringify(b),', _self.cb);if (typeof _self.result !== "undefined") {	_self.cb(_self.result);}']);return e.onmessage=function(a){d.resolve(a.data)},e.onerror=function(a){a.preventDefault(),d.reject(a.message)},d.promise}function mapWorker(a,b,d){if("undefined"==typeof Worker)return fakeMapWorker(a,b,d);var e=new Communist,f=makeWorker(["var _db = {};_db.__close__ = function () {	self.close();};var _self = {};_db.__fun__ = ",a,';_self.cb = function (data, transfer) {	!self._noTransferable ? self.postMessage(data, transfer) : self.postMessage(data);};self.onmessage = function (e) {	_self.result = _db.__fun__(e.data, _self.cb);	if (typeof _self.result !== "undefined") {		_self.cb(_self.result);	}}']);return f.onmessage=function(a){b(a.data)},f.onerror=d?d:function(){b()},e.data=function(a,b){return c._noTransferable?f.postMessage(a):f.postMessage(a,b),e},e.close=function(){return f.terminate()},e}function multiUse(a){return object({data:a})}function fakeObject(a){var b=new Communist,d=[];"initialize"in a||(a.initialize=function(){});var e=function(b){var e,f=function(f){var g=d.length;d[g]=c.deferred();var h=function(a){d[g].resolve(a)};try{e=a[b](f,h),"undefined"!=typeof e&&h(e)}catch(i){d[g].reject(i)}return d[g].promise};return f};for(var f in a)b[f]=e(f);return b._close=function(){return c.resolve()},"close"in b||(b.close=b._close),b.initialize(),b}function fakeMapWorker(a,b,c){var d=new Communist,e=fakeObject({data:a});return d.data=function(a){return e.data(a).then(b,c),d},d.close=e.close,d}function fakeReducer(a,b){var c,d=new Communist;return d.data=function(b){return c=c?a(c,b):b,d},d.fetch=function(){return b(c),d},d.close=function(a){a||b(c)},d}function object(a){if("undefined"==typeof Worker)return fakeObject(a);var b=new Communist,d=0,e=[],f=function(a){"string"!=typeof a&&a.preventDefault&&(a.preventDefault(),a=a.message),e.forEach(function(b){b&&b.reject(a)})};"initialize"in a||(a.initialize=function(){});var g="{",h=function(a){var b=function(b,d){var f=e.length;return e[f]=c.deferred(),c._noTransferable?j.postMessage([f,a,b]):j.postMessage([f,a,b],d),e[f].promise};return b};for(var i in a)0!==d?g+=",":d++,g=g+i+":"+a[i].toString(),b[i]=h(i);g+="}";var j=makeWorker(["var _db=",g,';self.onmessage=function(e){	var cb=function(data,transfer){		!self._noTransferable?self.postMessage([e.data[0],data],transfer):self.postMessage([e.data[0],data]);	};	var result = _db[e.data[1]](e.data[2],cb);	if(typeof result !== "undefined"){		cb(result);	}};_db.initialize();']);return j.onmessage=function(a){e[a.data[0]].resolve(a.data[1]),e[a.data[0]]=0},j.onerror=f,b._close=function(){return j.terminate(),f("closed"),c.resolve()},"close"in b||(b.close=b._close),b}function queue(a,b,d){function e(a){a=a||"canceled",r=0;var b=q;return q=[],b.forEach(function(b){b[3].reject(a)}),!0}function f(a){return function(b,c){return l(a,b,c)}}function g(a){return function(b){return c.all(b.map(function(b){return l(a,b)}))}}function h(a){return function(b){var d=this;return c.all(b.map(function(b){return l(a,b).then(d.__cb__)}))}}function i(a){return function(b){return c.all(b.map(function(b){return l(a,b[0],b[1])}))}}function j(a){return function(b){var d=this;return c.all(b.map(function(b){return l(a,b[0],b[1]).then(d.__cb__)}))}}function k(a){var b;r?(b=q.shift(),r--,n[a][b[0]](b[1],b[2]).then(function(c){k(a),b[3].resolve(c)},function(c){k(a),b[3].reject(c)})):(o++,p.push(a))}function l(a,e,f){if(d)return n[~~(Math.random()*b)][a](e,f);var g,h=c.deferred();return!r&&o?(g=p.pop(),o--,n[g][a](e,f).then(function(a){k(g),h.resolve(a)},function(a){k(g),h.reject(a)})):(r||!o)&&(r=q.push([a,e,f,h])),h.promise}var m=new Communist;m.__batchcb__=new Communist,m.__batchtcb__=new Communist,m.batch=function(a){return"function"==typeof a?(m.__batchcb__.__cb__=a,m.__batchcb__):e(a)},m.batchTransfer=function(a){return"function"==typeof a?(m.__batchtcb__.__cb__=a,m.__batchtcb__):e(a)};for(var n=new Array(b),o=0,p=[],q=[],r=0;b>o;)n[o]=object(a),p.push(o),o++;for(var s in a)m[s]=f(s),m.batch[s]=g(s),m.__batchcb__[s]=h(s),m.batchTransfer[s]=i(s),m.__batchtcb__[s]=j(s);return m._close=function(){return c.all(n.map(function(a){return a._close()}))},"close"in m||(m.close=m._close),m}function rWorker(a,b){if("undefined"==typeof Worker)return fakeReducer(a,b);var d=new Communist,e=["function (dat, cb) {	var fun = ",a,';	switch (dat[0]) {	case "data":		if (!this._r) {			this._r = dat[1];		}		else {			this._r = fun(this._r, dat[1]);		}		break;	case "get":		return cb(this._r);	case "close":		cb(this._r);		this.__close__();		break;	}};'],f=function(a){b(a)},g=mapWorker(e.join(""),f);return d.data=function(a,b){return c._noTransferable?g.data(["data",a]):g.data(["data",a],b),d},d.fetch=function(){return g.data(["get"]),d},d.close=function(a){a&&(b=function(){}),g.data(["close"])},d}function incrementalMapReduce(a){function b(){for(var a=0,b=i.length;b>a&&h>0&&k>0;)h--,i[a].data(j.pop()),a++,k--;return g}function d(){f.close(),i.forEach(function(a){a.close()})}var e,f,g=new Communist,h=0,i=[],j=[],k=a,l=!1,m=!1,n={map:!1,reduce:!1,data:!1},o=function(){return n.map&&n.reduce&&n.data?b():g};return g.map=function(b,c){function e(){var e,g=mapWorker(b,function(b){void 0!==typeof b&&f.data(b),h>0?(h--,e=j.pop(),c?g.data(e,[e]):g.data(e)):(k++,k===a&&(n.data=!1,m?d():l&&(l=!1,f.fetch())))});i.push(g)}if(n.map)return g;for(var p=0;a>p;)e(),p++;return n.map=!0,o()},g.reduce=function(a){return n.reduce?g:(f=rWorker(a,function(a){e&&(e.resolve(a),e=!1)}),n.reduce=!0,o())},g.data=function(a){return m?void 0:(h+=a.length,j=j.concat(a),n.data=!0,o())},g.fetch=function(b){return e||(e=c.deferred()),a>k&&!b?l=!0:f.fetch(),e.promise},g.close=function(){return e||(e=c.deferred()),a>k?m=!0:d(),e.promise},g}function nonIncrementalMapReduce(a){function b(){return e.data&&e.map&&e.reduce?d.close():c}var c=new Communist,d=incrementalMapReduce(a),e={data:!1,map:!1,reduce:!1};return c.map=function(a,c){return e.map=!0,d.map(a,c),b()},c.reduce=function(a){return e.reduce=!0,d.reduce(a),b()},c.data=function(a){return e.data=!0,d.data(a),b()},c}function c(a,b,c){return"number"!=typeof a&&"function"==typeof b?mapWorker(a,b,c):"object"!=typeof a||Array.isArray(a)?"number"!=typeof a?b?single(a,b):multiUse(a):"number"==typeof a?b?nonIncrementalMapReduce(a):incrementalMapReduce(a):void 0:"number"==typeof b?queue(a,b,c):object(a)}function initBrowser(a){var b=global.cw;a.noConflict=function(){global.cw=b},global.communist=a,global.cw=a}!function(attachTo,global){function isStringAndStartsWith(a,b){return"string"==typeof a&&a.substring(0,b.length)===b}function onGlobalMessage(a){if(a.source===global&&isStringAndStartsWith(a.data,MESSAGE_PREFIX)){var b=a.data.substring(MESSAGE_PREFIX.length);tasks.runIfPresent(b)}}var tasks=function(){function Task(a,b){this.handler=a,this.args=b}Task.prototype.run=function(){if("function"==typeof this.handler)this.handler.apply(void 0,this.args);else{var scriptSource=""+this.handler;eval(scriptSource)}};var nextHandle=1,tasksByHandle={},currentlyRunningATask=!1;return{addFromSetImmediateArguments:function(a){var b=a[0],c=Array.prototype.slice.call(a,1),d=new Task(b,c),e=nextHandle++;return tasksByHandle[e]=d,e},runIfPresent:function(a){if(currentlyRunningATask)global.setTimeout(function(){tasks.runIfPresent(a)},0);else{var b=tasksByHandle[a];if(b){currentlyRunningATask=!0;try{b.run()}finally{delete tasksByHandle[a],currentlyRunningATask=!1}}}},remove:function(a){delete tasksByHandle[a]}}}(),MESSAGE_PREFIX="com.communistjs.setImmediate"+Math.random();global.addEventListener?global.addEventListener("message",onGlobalMessage,!1):global.attachEvent("onmessage",onGlobalMessage),attachTo.setImmediate=function(){var a=tasks.addFromSetImmediateArguments(arguments);return global.postMessage(MESSAGE_PREFIX+a,"*"),a}}(c,global),function(a){function b(){var a=function(g,h,i){var j;if(g!==a)return j=b(),a.c.push({d:j,resolve:g,reject:h}),j.promise;for(var k,l,m,n=h?"resolve":"reject",o=0,p=a.c.length;p>o;o++)k=a.c[o],l=k.d,m=k[n],typeof m!==e?l[n](i):d(m,i,l);a=c(f,i,h)},f={then:function(b,c){return a(b,c)}};return a.c=[],{promise:f,resolve:function(b){a.c&&a(a,!0,b)},reject:function(b){a.c&&a(a,!1,b)}}}function c(a,c,f){return function(g,h){var i,j=f?g:h;return typeof j!==e?a:(d(j,c,i=b()),i.promise)}}function d(b,c,d){a.setImmediate(function(){var a;try{a=b(c),a&&typeof a.then===e?a.then(d.resolve,d.reject):d.resolve(a)}catch(f){d.reject(f)}})}var e="function";a.resolve=function(a){var b={};return b.then=c(b,a,!0),b},a.reject=function(a){var b={};return b.then=c(b,a,!1),b},a.deferred=b}(c),c.all=function(a){var b=c.deferred(),d=a.length,e=0,f=new Array(d),g=function(a){return function(c){f[a]=c,e++,e===d&&b.resolve(f)}};return a.forEach(function(a,c){a.then(g(c),function(a){b.reject(a)})}),b.promise};var Communist=function(){};c.reducer=rWorker,c.worker=makeWorker,c.makeUrl=function(a){var b=document.createElement("link");return b.href=a,b.href},c.ajax=function(a,b,d){var e=d?"request.responseText":"JSON.parse(request.responseText)",f=b?"("+b.toString()+")("+e+",_cb)":e,g='function (url, _cb) {\n		var request = new XMLHttpRequest();\n		request.open("GET", url);\n			request.onreadystatechange = function() {\n				var _resp;\n				if (request.readyState === 4 && request.status === 200) {\n_resp = '+f+';\n					if(typeof _resp!=="undefined"){_cb(_resp);}\n					}\n			};\n			request.onerror=function(e){throw(e);}\n		request.send();\n	}';return c(g,c.makeUrl(a))},"undefined"==typeof module?initBrowser(c):module.exports=c}(this);
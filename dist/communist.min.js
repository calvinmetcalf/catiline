/*! communist 2.0.0 2013-07-22*/
/*!(c)2013 Calvin Metcalf @license MIT https://github.com/calvinmetcalf/communist */
/*!Includes Promiscuous (c)2013 Ruben Verborgh @license MIT https://github.com/RubenVerborgh/promiscuous*/
/*!Includes Material from setImmediate Copyright (c) 2012 Barnesandnoble.com, llc, Donavon West, and Domenic Denicola @license MIT https://github.com/NobleJS/setImmediate */
"undefined"==typeof document?(self._noTransferable=!0,self.onmessage=function(e){eval(e.data)}):function(global){"use strict";function regexImports(a){for(var b=a,c=!0,d={},e=function(a,b){b&&"importScripts("+b.split(",").forEach(function(a){d[communist.makeUrl(a.match(/\s*[\'\"](\S*)[\'\"]\s*/)[1])]=!0})+");\n"};c;)c=b.match(/(importScripts\(.*?\);?)/),b=b.replace(/(importScripts\(\s*(?:[\'\"].*?[\'\"])?\s*\);?)/,"\n"),c&&c[0].replace(/importScripts\(\s*([\'\"].*?[\'\"])?\s*\);?/g,e);return d=Object.keys(d),[d,b]}function moveImports(a){var b=regexImports(a),c=b[0],d=b[1];return c.length>0?'importScripts("'+c.join('","')+'");\n'+d:d}function getPath(){if("undefined"!=typeof SHIM_WORKER_PATH)return SHIM_WORKER_PATH;for(var a=document.getElementsByTagName("script"),b=a.length,c=0;b>c;){if(/communist(\.min)?\.js/.test(a[c].src))return a[c].src;c++}}function fakeObject(inObj){function ajax(a){var b=communist.deferred(),c=new XMLHttpRequest;return c.open("GET",a),c.onload=function(){b.resolve(c.responseText)},c.onerror=function(){b.reject("failed to download")},c.send(),b.promise}function addEvents(a,b){a.on=function(b,c,d){return d=d||a,b.indexOf(" ")>0?(b.split(" ").map(function(b){return a.on(b,c,d)},this),a):(b in wlisteners||(wlisteners[b]=[]),wlisteners[b].push(function(a){c.call(d,a)}),void 0)},a.fire=function(b,c){return communist.setImmediate(function(){b in olisteners&&Array.isArray(olisteners[b])&&olisteners[b].forEach(function(a){a(c)})}),a},a.off=function(b,c){return b.indexOf(" ")>0?(b.split(" ").map(function(b){return a.off(b,c)}),a):b in wlisteners?(c?wlisteners[b].indexOf(c)>-1&&(wlisteners[b].length>1?delete wlisteners[b]:wlisteners[b].splice(wlisteners[b].indexOf(c),1)):delete wlisteners[b],a):a},b.on=function(a,c,d){return d=d||b,a.indexOf(" ")>0?(a.split(" ").map(function(a){return b.on(a,c,d)},this),b):(a in olisteners||(olisteners[a]=[]),olisteners[a].push(function(a){try{c.call(d,a,b)}catch(e){b.fire("error",{preventDefault:function(){},messege:e})}}),b)},b.fire=function(a,c){return a in wlisteners?(wlisteners[a].forEach(function(a){a(c)}),b):b},b.off=function(a,c){return a.indexOf(" ")>0?(a.split(" ").map(function(a){return b.off(a,c)}),b):a in olisteners?(c?olisteners[a].indexOf(c)>-1&&(olisteners[a].length>1?delete olisteners[a]:olisteners[a].splice(olisteners[a].indexOf(c),1)):delete olisteners[a],b):b}}var w=new Communist,promises=[],loaded=!1,wlisteners={},olisteners={},loading,called=!1,rejectPromises=function(a){"string"!=typeof a&&a.preventDefault&&(a.preventDefault(),a=a.message),promises.forEach(function(b){b&&b.reject(a)})},obj;"initialize"in inObj||(inObj.initialize="init"in inObj?inObj.init:function(){});var keyFunc=function(a){var b=function(b){var c,d,e;d=promises.length,called||(called=!0),promises[d]=communist.deferred(),e=function(a){promises[d].resolve(a)};try{c=obj[a].call(obj,b,e,obj),"undefined"!=typeof c&&e(c)}catch(f){obj.fire("error",f),promises[d].reject(f)}return promises[d].promise};return function(a){return loaded?b(a):loading.then(function(){return b(a)})}},i=0,fObj="{";for(var key in inObj)0!==i?fObj+=",":i++,fObj=fObj+key+":"+inObj[key].toString(),w[key]=keyFunc(key);fObj+="}";var re=/(\S+?:function\s*?)([a-zA-Z0-9$_]+?)(\s*?\()/g,regexed=regexImports(fObj),forImport=regexed[0];return 0===forImport.length?(loaded=!0,function(){eval("obj = "+regexed[1].replace(re,"$1$3"))}(),addEvents(w,obj)):loading=communist.all(forImport.map(function(a){return ajax(a)})).then(function(array){return eval(array.join("\n")+";\nobj = "+regexed[1].replace(re,"$1$3")),addEvents(w,obj),!0}),w._close=function(){return olisteners={},wlisteners={},promises.forEach(function(a){a.reject("closed")}),communist.resolve()},"close"in w||(w.close=w._close),called||w.initialize(obj),w}function communist(a,b,c){return 1===arguments.length?communist.worker(a):communist.queue(a,b,c)}function initBrowser(a){var b=global.cw;a.noConflict=function(c){global.cw=b,c&&(global[c]=a)},global.communist=a,global.cw=a}!function(attachTo,global){function isStringAndStartsWith(a,b){return"string"==typeof a&&a.substring(0,b.length)===b}function onGlobalMessage(a){if(a.source===global&&isStringAndStartsWith(a.data,MESSAGE_PREFIX)){var b=a.data.substring(MESSAGE_PREFIX.length);tasks.runIfPresent(b)}}var tasks=function(){function Task(a,b){this.handler=a,this.args=b}Task.prototype.run=function(){if("function"==typeof this.handler)this.handler.apply(void 0,this.args);else{var scriptSource=""+this.handler;eval(scriptSource)}};var nextHandle=1,tasksByHandle={},currentlyRunningATask=!1;return{addFromSetImmediateArguments:function(a){var b=a[0],c=Array.prototype.slice.call(a,1),d=new Task(b,c),e=nextHandle++;return tasksByHandle[e]=d,e},runIfPresent:function(a){if(currentlyRunningATask)global.setTimeout(function(){tasks.runIfPresent(a)},0);else{var b=tasksByHandle[a];if(b){currentlyRunningATask=!0;try{b.run()}finally{delete tasksByHandle[a],currentlyRunningATask=!1}}}},remove:function(a){delete tasksByHandle[a]}}}(),MESSAGE_PREFIX="com.communistjs.setImmediate"+Math.random();global.addEventListener?global.addEventListener("message",onGlobalMessage,!1):global.attachEvent("onmessage",onGlobalMessage),attachTo.setImmediate=function(){var a=tasks.addFromSetImmediateArguments(arguments);return global.postMessage(MESSAGE_PREFIX+a,"*"),a}}(communist,global),function(a){function b(){var a=function(g,h,i){var j;if(g!==a)return j=b(),a.c.push({d:j,resolve:g,reject:h}),j.promise;for(var k,l,m,n=h?"resolve":"reject",o=0,p=a.c.length;p>o;o++)k=a.c[o],l=k.d,m=k[n],typeof m!==e?l[n](i):d(m,i,l);a=c(f,i,h)},f={then:function(b,c){return a(b,c)}};return a.c=[],{promise:f,resolve:function(b){a.c&&a(a,!0,b)},reject:function(b){a.c&&a(a,!1,b)}}}function c(a,c,f){return function(g,h){var i,j=f?g:h;return typeof j!==e?a:(d(j,c,i=b()),i.promise)}}function d(b,c,d){a.setImmediate(function(){var a;try{a=b(c),a&&typeof a.then===e?a.then(d.resolve,d.reject):d.resolve(a)}catch(f){d.reject(f)}})}var e="function";a.resolve=function(a){var b={};return b.then=c(b,a,!0),b},a.reject=function(a){var b={};return b.then=c(b,a,!1),b},a.deferred=b,a.all=function(b){var c=a.deferred(),d=b.length,e=0,f=[],g=function(a){return function(b){f[a]=b,e++,e===d&&c.resolve(f)}};return b.forEach(function(a,b){a.then(g(b),function(a){c.reject(a)})}),c.promise}}(communist);var Communist=function(){};communist.makeWorker=function(a){var b,c=moveImports(a.join(""));communist.URL=communist.URL||window.URL||window.webkitURL;try{b=new Worker(communist.URL.createObjectURL(new Blob([c],{type:"text/javascript"})))}catch(d){communist._noTransferable=!0,b=new Worker(getPath()),b.postMessage(c)}finally{return b}},communist.worker=function(a){if("function"==typeof a&&(a={data:a}),"undefined"==typeof Worker||"undefined"!=typeof fakeLegacy)return fakeObject(a);var b={},c=new Communist;c.on=function(a,d,e){return e=e||c,a.indexOf(" ")>0?(a.split(" ").map(function(a){return c.on(a,d,e)},this),c):(a in b||(b[a]=[]),b[a].push(function(a){d.call(e,a)}),c)};var d=function(a,d){return a in b?(b[a].forEach(function(a){a(d)}),c):c};c.fire=function(a,b,d){return communist._noTransferable?k.postMessage([[a],b]):k.postMessage([[a],b],d),c},c.off=function(a,d){return a.indexOf(" ")>0?(a.split(" ").map(function(a){return c.off(a,d)}),c):a in b?(d?b[a].indexOf(d)>-1&&(b[a].length>1?delete b[a]:b[a].splice(b[a].indexOf(d),1)):delete b[a],c):c};var e=0,f=[],g=function(a){"string"!=typeof a&&"preventDefault"in a&&(a.preventDefault(),a=a.message),f.forEach(function(b){b&&b.reject(a)})};"initialize"in a||(a.initialize="init"in a?a.init:function(){});var h="{",i=function(a){var b=function(b,c){var d=f.length;return f[d]=communist.deferred(),communist._noTransferable?k.postMessage([["com.communistjs",d],a,b]):k.postMessage([["com.communistjs",d],a,b],c),f[d].promise};return b};for(var j in a)0!==e?h+=",":e++,h=h+j+":"+a[j].toString(),c[j]=i(j);h+="}";var k=communist.makeWorker(['"use strict";var _db = ',h,';var listeners = {};_db.on = function (eventName, func, scope) {	if(eventName.indexOf(" ")>0){		return eventName.split(" ").map(function(v){			return _db.on(v,func,scope);		},_db);	}	scope = scope || _db;	if (!(eventName in listeners)) {		listeners[eventName] = [];	}	listeners[eventName].push(function (a) {		func.call(scope, a, _db);	});};var _fire = function (eventName, data) {	if (!(eventName in listeners)) {		return;	}	listeners[eventName].forEach(function (v) {		v(data);	});};_db.fire = function (eventName, data, transfer) {	!self._noTransferable ? self.postMessage([		[eventName], data], transfer) : self.postMessage([		[eventName], data]);};_db.off=function(eventName,func){	if(eventName.indexOf(" ")>0){		return eventName.split(" ").map(function(v){			return _db.off(v,func);		});	}	if(!(eventName in listeners)){		return;	}else if(!func){		delete listeners[eventName];	}else{		if(listeners[eventName].indexOf(func)>-1){			if(listeners[eventName].length>1){				delete listeners[eventName];			}else{				listeners[eventName].splice(listeners[eventName].indexOf(func),1);			}		}	}};var console={};function makeConsole(method){	return function(){		var len = arguments.length;		var out =[];		var i = 0;		while (i<len){			out.push(arguments[i]);			i++;		}		_db.fire("console",[method,out]);	};}["log", "debug", "error", "info", "warn", "time", "timeEnd"].forEach(function(v){	console[v]=makeConsole(v);});self.onmessage=function(e){	_fire("messege",e.data[1]);	if(e.data[0][0]==="com.communistjs"){		return regMsg(e);	}else{		_fire(e.data[0][0],e.data[1]);	}};var regMsg = function(e){	var cb=function(data,transfer){		!self._noTransferable?self.postMessage([e.data[0],data],transfer):self.postMessage([e.data[0],data]);	};	var result = _db[e.data[1]](e.data[2],cb,_db);	if(typeof result !== "undefined"){		cb(result);	}};_db.initialize(_db);']);return k.onmessage=function(a){d("message",a.data[1]),"com.communistjs"===a.data[0][0]?(f[a.data[0][1]].resolve(a.data[1]),f[a.data[0][1]]=0):d(a.data[0][0],a.data[1])},k.onerror=function(a){g(a),d("error",a)},c.on("console",function(a){console[a[0]].apply(console,a[1])}),c._close=function(){return k.terminate(),g("closed"),communist.resolve()},"close"in c||(c.close=c._close),c},communist.queue=function(a,b,c){function d(a){a=a||"canceled",q=0;var b=p;return p=[],b.forEach(function(b){b[3].reject(a)}),l}function e(a){return function(b,c){return k(a,b,c)}}function f(a){return function(b){return communist.all(b.map(function(b){return k(a,b)}))}}function g(a){return function(b){var c=this;return communist.all(b.map(function(b){return k(a,b).then(c.__cb__)}))}}function h(a){return function(b){return communist.all(b.map(function(b){return k(a,b[0],b[1])}))}}function i(a){return function(b){var c=this;return communist.all(b.map(function(b){return k(a,b[0],b[1]).then(c.__cb__)}))}}function j(a){var b;q?(b=p.shift(),q--,m[a][b[0]](b[1],b[2]).then(function(c){j(a),b[3].resolve(c)},function(c){j(a),b[3].reject(c)})):(n++,o.push(a))}function k(a,d,e){if(c)return m[~~(Math.random()*b)][a](d,e);var f,g=communist.deferred();return!q&&n?(f=o.pop(),n--,m[f][a](d,e).then(function(a){j(f),g.resolve(a)},function(a){j(f),g.reject(a)})):(q||!n)&&(q=p.push([a,d,e,g])),g.promise}var l=new Communist;l.__batchcb__=new Communist,l.__batchtcb__=new Communist,l.batch=function(a){return"function"==typeof a?(l.__batchcb__.__cb__=a,l.__batchcb__):d(a)},l.batchTransfer=function(a){return"function"==typeof a?(l.__batchtcb__.__cb__=a,l.__batchtcb__):d(a)};for(var m=new Array(b),n=0,o=[],p=[],q=0;b>n;)m[n]=communist.worker(a),o.push(n),n++;l.on=function(a,b,c){return m.forEach(function(d){d.on(a,b,c)}),l},l.off=function(a,b,c){return m.forEach(function(d){d.off(a,b,c)}),l};var r=function(a,b){return m.forEach(function(c){c.fire(a,b)}),l};l.fire=function(a,c){return m[~~(Math.random()*b)].fire(a,c),l},l.batch.fire=r,l.batchTransfer.fire=r;for(var s in a)l[s]=e(s),l.batch[s]=f(s),l.__batchcb__[s]=g(s),l.batchTransfer[s]=h(s),l.__batchtcb__[s]=i(s);return l._close=function(){return communist.all(m.map(function(a){return a._close()}))},"close"in l||(l.close=l._close),l},communist.makeUrl=function(a){var b=document.createElement("link");return b.href=a,b.href},"undefined"!=typeof module&&"exports"in module?module.exports=communist:initBrowser(communist),communist.version="2.0.0"}(this);